<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes flash {
            0% { background-color: #d1fae5; }
            50% { background-color: #a7f3d0; }
            100% { background-color: white; }
        }

        #refresh-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #1e40af;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .auto-refresh-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #166534;
            font-weight: 500;
        }

        .auto-refresh-badge .pulse {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>

<body>
    <%- include('../partials/header') %>

        <main class="container">
            <div class="page-header">
                <h1 class="page-title">
                    Mes Appareils
                </h1>
                <div style="display: flex; gap: 1rem;">
                    <a href="/" class="btn btn-secondary">
                        Retour
                    </a>
                    <a href="/logout" class="btn btn-logout">
                        Déconnexion
                    </a>
                </div>
            </div>

            <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
                <div class="auto-refresh-badge">
                    <span class="pulse"></span>
                    <span>Actualisation automatique (5s)</span>
                </div>
                <div id="refresh-indicator">
                    <span>Mise à jour...</span>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Gestion des appareils connectés</h3>
                <p class="card-description">
                    Cette section permettra de gérer les appareils connectés à votre compte via le Device Flow OAuth2.
                </p>

                <% if (devices && devices.length > 0) { %>
                    <div class="devices-list">
                        <h3 class="card-title">Appareils connectés</h3>
                        <p class="card-description" style="margin-bottom: 20px;">
                            Liste des appareils authentifiés via le Device Flow OAuth2 (récupérés depuis Keycloak).
                        </p>

                        <% devices.forEach((device, index) => { %>
                            <% device.sessions.forEach((session, sessionIndex) => { %>
                                <%
                                    // Filtrer pour ne montrer que le client devicecis
                                    const deviceClients = session.clients ? session.clients.filter(c => c.clientId === 'devicecis') : [];
                                %>
                                <% if (deviceClients.length > 0) { %>
                                <div class="device-card" style="background: white; border: 2px solid #10b981; padding: 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <h4 style="margin: 0 0 15px 0; color: #047857; display: flex; align-items: center; gap: 10px;">
                                        Device #<%= (index * device.sessions.length + sessionIndex + 1) %>
                                    </h4>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f9fafb; padding: 15px; border-radius: 5px;">
                                        <div>
                                            <p style="margin: 5px 0; color: #374151;"><strong>Adresse IP:</strong> <%= session.ipAddress %></p>
                                            <p style="margin: 5px 0; color: #374151;"><strong>Session ID:</strong> <code style="background: #e5e7eb; padding: 2px 6px; border-radius: 3px; font-size: 0.85rem; color: #1f2937;"><%= session.id.substring(0, 20) %>...</code></p>
                                        </div>
                                        <div>
                                            <p style="margin: 5px 0; color: #374151;"><strong>Connecté le:</strong> <%= new Date(session.started * 1000).toLocaleString('fr-FR') %></p>
                                            <p style="margin: 5px 0; color: #374151;"><strong>Dernière activité:</strong> <%= new Date(session.lastAccess * 1000).toLocaleString('fr-FR') %></p>
                                        </div>
                                    </div>

                                    <% if (session.expires) { %>
                                        <p style="margin: 15px 0 5px 0; color: #374151;"><strong>Expire le:</strong> <%= new Date(session.expires * 1000).toLocaleString('fr-FR') %></p>
                                    <% } %>

                                    <div style="margin-top: 15px; padding: 12px; background: #d1fae5; border-radius: 5px; border-left: 4px solid #10b981;">
                                        <% deviceClients.forEach(client => { %>
                                            <p style="margin: 0; color: #065f46; font-weight: 600;">
                                                <%= client.clientName || client.clientId %>
                                                <% if (client.clientId !== client.clientName) { %>
                                                    <span style="color: #047857; font-size: 0.9rem; font-weight: 400;"> (<code><%= client.clientId %></code>)</span>
                                                <% } %>
                                            </p>
                                        <% }); %>
                                    </div>
                                </div>
                                <% } %>
                            <% }); %>
                        <% }); %>

                        <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 5px;">
                            <p style="margin: 0; color: #166534;">
                                <strong>Architecture correcte:</strong> Les devices sont récupérés depuis Keycloak Account API
                                (source unique de vérité). WebApp n'interroge jamais device-app directement.
                            </p>
                        </div>
                    </div>
                <% } else { %>
                    <div class="info-box">
                        <div class="info-content">
                            <h4>Aucun appareil connecté</h4>
                            <p>Démarrez device-app sur <a href="http://localhost:4000" target="_blank" style="color: #3b82f6; font-weight: 600;">http://localhost:4000</a> et authentifiez-vous pour voir vos appareils ici.</p>
                            <p style="margin-top: 10px; color: #6b7280; font-size: 0.95rem;">
                                Les appareils authentifiés via le Device Flow OAuth2 apparaîtront automatiquement dans cette liste.
                            </p>
                        </div>
                    </div>
                <% } %>

                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="location.reload()" class="btn btn-primary">
                        Actualiser la liste
                    </button>
                </div>
            </div>
        </main>

        <%- include('../partials/footer') %>

            <script src="/js/main.js"></script>
</body>

</html>